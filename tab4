from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_squared_error

with st.expander("ğŸ¤– ë¨¸ì‹ ëŸ¬ë‹: ë³„ì  ì˜ˆì¸¡"):
    st.markdown("ì´ ë¶„ì„ì€ ê³ ê° ì •ë³´ì™€ êµ¬ë§¤ íŠ¹ì„±ìœ¼ë¡œë¶€í„° ë³„ì ì„ ì˜ˆì¸¡í•©ë‹ˆë‹¤.")
    
    ml_df = filtered_df.copy()
    ml_df = ml_df.dropna(subset=['Review Rating'])  # ë³„ì  ì—†ëŠ” ê²½ìš° ì œê±°

    # ìˆ«ìë¡œ ë³€í™˜
    ml_df_encoded = pd.get_dummies(ml_df[["Age", "Gender", "Category", "Payment Method", "Shopping Channel"]])
    ml_df_encoded["Purchase"] = ml_df["Purchase Amount (USD)"]
    X = ml_df_encoded
    y = ml_df["Review Rating"]

    X_train, X_test, y_train, y_test = train_test_split(X, y, random_state=42)
    model = RandomForestRegressor()
    model.fit(X_train, y_train)
    y_pred = model.predict(X_test)
    rmse = mean_squared_error(y_test, y_pred, squared=False)

    st.write(f"ì˜ˆì¸¡ RMSE (ë‚®ì„ìˆ˜ë¡ ì •í™•): {rmse:.2f}")

    # ì‚¬ìš©ì ì…ë ¥ìœ¼ë¡œ ì˜ˆì¸¡ í…ŒìŠ¤íŠ¸
    st.markdown("### ğŸ¯ ë³„ì  ì˜ˆì¸¡ í…ŒìŠ¤íŠ¸")
    test_input = {
        "Age": st.slider("ë‚˜ì´", 18, 70, 30),
        "Purchase": st.slider("êµ¬ë§¤ê¸ˆì•¡", 10, 1000, 100),
        "Gender_Female": st.radio("ì„±ë³„", ["Female", "Male"]) == "Female",
        "Category_Clothing": st.radio("ì¹´í…Œê³ ë¦¬", ["Clothing", "Accessories", "Shoes"]) == "Clothing",
        "Payment Method_Credit Card": st.radio("ê²°ì œ ë°©ì‹", ["Credit Card", "Paypal", "Cash"]) == "Credit Card",
        "Shopping Channel_Online": st.radio("ì‡¼í•‘ ì±„ë„", ["Online", "Offline"]) == "Online"
    }

    test_df = pd.DataFrame([test_input])
    y_test_pred = model.predict(test_df)[0]
    st.success(f"ì˜ˆì¸¡ ë³„ì : {y_test_pred:.2f} / 5.0")
